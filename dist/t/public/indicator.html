<!DOCTYPE html>
<html>

<head>
    <title>BuySellSymbols</title>
    <script src="https://github.com/tam888888/stockData/releases/download/1.0.0/symbols.js"></script>
    <script src="https://github.com/tam888888/stockData/releases/download/1.0.0/filter.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <!-- <script src="https://cdn.datatables.net/scroller/2.3.0/js/dataTables.scroller.min.js"></script> -->
    <script src="https://cdn.datatables.net/keytable/2.11.0/js/dataTables.keyTable.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>

    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/scroller/2.3.0/css/scroller.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/keytable/2.11.0/css/keyTable.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">


    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
        integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        table,
        th,
        td {
            border: 1px solid #ccc;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
    <style>
        /* CSS for limiting the number of rows and adding a vertical scroll */
        #timelineContainer {
            max-height: 600px;
            /* Set the maximum height for the table */
            overflow-y: auto;
            /* Enable vertical scrolling */
        }
    </style>
    <style>
        /* CSS for enabling both horizontal and vertical scrolling for the entire page */
        body,
        html {
            overflow: scroll;
            /* Enable both horizontal and vertical scrolling for the entire page */
        }

        .custom-dialog {
            border-color: darkmagenta;
            border-radius: 10px;
            border-width: 5px;

            width: 200%;
            /* height: 100%; */
            /* Add any additional styles you want to inherit from modal-dialog */
        }

        .custom-fade {
            width: 100%;
            height: 100%;
            margin-left: 15%;
            /* margin-right: 10%; */
            /* Add any additional styles you want to inherit from modal-dialog */
        }

        @media (max-width: 2048px) {
            .custom-fade {
                margin-left: 0;
                /* Set margin-left to 0% for mobile */
                margin-right: 0;
                /* Set margin-right to 0% for mobile */
            }
        }

        .headerCheck {
            font-weight: bold;
            color: chartreuse;
            background-color: blueviolet;
        }

        .custom-header {
            font-weight: bold;
            color: chartreuse;
            background-color: blueviolet;
        }

        .seperator {
            width: 100%;
            font-weight: bold;
            color: chartreuse;
            background-color: darkorchid;
            text-align: center;
        }
    </style>

</head>

<body>
    <div class="modal fade custom-fade" id="settingsModal" tabindex="-1" role="dialog"
        aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog custom-fade" role="document">
            <div class="modal-content custom-dialog">
                <div class="modal-header custom-header">
                    <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Thiết lập các thuộc tính sẽ được hiển thị.</p>
                    <div id="indicatorCheckboxes">
                        <div class="headerCheck">Thuộc tính cơ bản</div>
                        <div id="basic" class="d-flex flex-wrap flex-row"></div>
                        <div class="headerCheck">MACD</div>
                        <div id="macd" class="d-flex flex-wrap flex-row"></div>
                        <div class="headerCheck">Bollinger Bands</div>
                        <div id="bb" class="d-flex flex-wrap flex-row"></div>
                        <div class="headerCheck">Price</div>
                        <div id="price" class="d-flex flex-wrap flex-row"></div>
                        <div class="headerCheck">Volume</div>
                        <div id="vol" class="d-flex flex-wrap flex-row"></div>
                        <div class="headerCheck">Value</div>
                        <div id="val" class="d-flex flex-wrap flex-row"></div>
                        <div class="headerCheck">Other</div>
                        <div id="other" class="d-flex flex-wrap flex-row"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <table id="symbolTable" class="display">
        <thead id="symbolHeadTable">
            <tr>
                <th>'Mã'</th>
                <th>'Thời gian'</th>
                <th>'Ngày'</th>
                <th>'Giá'</th>
                <th>'Thay Đổi'</th>
                <th>'%'</th>
                <th>'Vol Đặt Mua'</th>
                <th>'Val Đặt Mua'</th>
                <th>'Vol Đặt Bán'</th>
                <th>'Val Đặt Bán'</th>
                <th>'Vol MuaCĐ'</th>
                <th>'Val MuaCĐ'</th>
                <th>'Vol BánCĐ'</th>
                <th>'Val BánCĐ'</th>
                <th>'Vol KoXĐ'</th>
                <th>'Val KoXĐ'</th>
                <th>'Vol Tổng'</th>
                <th>'Val Tổng'</th>
                <th>'Vol Mua-Bán'</th>
                <th>'Val Mua-Bán'</th>
            </tr>
        </thead>
        <tfoot id="symbolFootTable">
            <tr>
                <th>Thống kê</th>
            </tr>
        </tfoot>
        <tbody>
            <!-- Dữ liệu sẽ được thêm ở đây -->
        </tbody>

    </table>

    <table id="symbolChangeTable" class="display">
        <thead id="symbolChangeHeadTable">
            <tr>
                <th>'Mã'</th>
                <th>'Thời gian'</th>
                <th>'Ngày'</th>
                <th>'Giá'</th>
                <th>'Thay Đổi'</th>
                <th>'%'</th>
                <th>'Vol Đặt Mua'</th>
                <th>'Val Đặt Mua'</th>
                <th>'Vol Đặt Bán'</th>
                <th>'Val Đặt Bán'</th>
                <th>'Vol MuaCĐ'</th>
                <th>'Val MuaCĐ'</th>
                <th>'Vol BánCĐ'</th>
                <th>'Val BánCĐ'</th>
                <th>'Vol KoXĐ'</th>
                <th>'Val KoXĐ'</th>
                <th>'Vol Tổng'</th>
                <th>'Val Tổng'</th>
                <th>'Vol Mua-Bán'</th>
                <th>'Val Mua-Bán'</th>
            </tr>
        </thead>
        <tfoot id="symbolChangeFootTable">
            <tr>
                <th>Thống kê</th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
        <tbody>
            <!-- Dữ liệu sẽ được thêm ở đây -->
        </tbody>

    </table>
    <script>
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        function getNowDate() {
            let fd = new Date();
            return fd.getFullYear()
                + "" + (fd.getMonth() + 1 < 10 ? "0" + (fd.getMonth() + 1) : fd.getMonth() + 1)
                + "" + (fd.getDate() < 10 ? "0" + fd.getDate() : fd.getDate());
        }

        $.fn.dataTable.ext.errMode = 'none';
        const url = new URL(window.location.href);
        const queryParams = url.searchParams;
        var interval = queryParams.get('interval');
        if (!interval) interval = 60
        var filterScript = queryParams.get('filter');
        if (!filterScript) filterScript = ''

        var querydate = queryParams.get('querydate');
        if (!querydate) querydate = getNowDate()
        let a = new Promise((resolve, reject) => {
            $.ajax({
                url: '/api/getsymbols',
                method: 'GET',
                success: function (response) {
                    resolve(response)
                },
                error: function (error) {
                    console.error('Error fetching updated data:', error);
                }
            });
        })
        a.then(data => {
            // console.table(data)
        })

        // statsHead = document.getElementById('symbolHeadTable');
        // statsHead.innerHTML = ''
        // var theadRow = document.createElement('tr');
        // statsHead.appendChild(theadRow);

        // let label1 = ['Mã', 'Thời gian', 'T', 'Vol Đặt Mua', 'Val Đặt Mua',
        //     'Vol Đặt Bán', 'Val Đặt Bán', 'Vol MuaCĐ', 'Val MuaCĐ', 'Vol BánCĐ', 'Val BánCĐ', 'Vol KoXĐ', 'Val KoXĐ', 'Vol Mua-Bán', 'Val Mua-Bán'
        // ]
        // for (var i = 0; i < label1.length; i++) {
        //     var th = document.createElement('th');
        //     th.textContent = label1[i];
        //     theadRow.appendChild(th);
        // }

        var mapFieldShowHide = localStorage.getItem("mapFieldShowHide");
        var defaultShowHide = true;
        if (!mapFieldShowHide) {
            defaultShowHide = true;
            mapFieldShowHide = {}
        } else {
            mapFieldShowHide = JSON.parse(mapFieldShowHide)
            defaultShowHide = false;
        }

        var basicField = ['Mã', 'Thời gian', 'T', 'Giá', 'Thay Đổi', '%', 'Vol Đặt Mua', 'Val Đặt Mua', 'Vol Đặt Bán', 'Val Đặt Bán', 'Vol MuaCĐ', 'Val MuaCĐ', 'Vol BánCĐ', 'Val BánCĐ', 'Vol KoXĐ', 'Val KoXĐ', 'Vol Tổng', 'Val Tổng', 'Vol Mua-Bán', 'Val Mua-Bán']
        var mapFieldIndex = {}
        var indicatorField = ['macd_histogram', 'macd_macd', 'macd_signal', 'price_bb_lower', 'price_bb_middle', 'price_bb_pb', 'price_bb_upper', 'price_ema_5', 'price_ema_9', 'price_ema_10', 'price_ema_12', 'price_ema_20', 'price_ema_25', 'price_ema_26', 'price_ema_30', 'price_ema_50', 'price_ema_100', 'price_ema_200', 'price_ma_5', 'price_ma_9', 'price_ma_10', 'price_ma_12', 'price_ma_20', 'price_ma_25', 'price_ma_26', 'price_ma_30', 'price_ma_50', 'price_ma_100', 'price_ma_200', 'price_max_5', 'price_max_10', 'price_max_20', 'price_max_26', 'price_max_30', 'price_max_200', 'price_max_1000', 'price_min_5', 'price_min_10', 'price_min_20', 'price_min_26', 'price_min_30', 'price_min_200', 'price_min_1000', 'rsi', 'val_5', 'val_10', 'val_20', 'val_26', 'val_30', 'val_200', 'val_1000', 'val_max_5', 'val_max_10', 'val_max_20', 'val_max_26', 'val_max_30', 'val_max_200', 'val_max_1000', 'val_min_5', 'val_min_10', 'val_min_20', 'val_min_26', 'val_min_30', 'val_min_200', 'val_min_1000', 'vol_5', 'vol_10', 'vol_20', 'vol_26', 'vol_30', 'vol_200', 'vol_1000', 'vol_max_5', 'vol_max_10', 'vol_max_20', 'vol_max_26', 'vol_max_30', 'vol_max_200', 'vol_max_1000', 'vol_min_5', 'vol_min_10', 'vol_min_20', 'vol_min_26', 'vol_min_30', 'vol_min_200', 'vol_min_1000',]
        var pctField = ['price_bb_lower', 'price_bb_middle', 'price_bb_pb', 'price_bb_upper', 'price_ema_5', 'price_ema_9', 'price_ema_10', 'price_ema_12', 'price_ema_20', 'price_ema_25', 'price_ema_26', 'price_ema_30', 'price_ema_50', 'price_ema_100', 'price_ema_200', 'price_ma_5', 'price_ma_9', 'price_ma_10', 'price_ma_12', 'price_ma_20', 'price_ma_25', 'price_ma_26', 'price_ma_30', 'price_ma_50', 'price_ma_100', 'price_ma_200', 'price_max_5', 'price_max_10', 'price_max_20', 'price_max_26', 'price_max_30', 'price_max_200', 'price_max_1000', 'price_min_5', 'price_min_10', 'price_min_20', 'price_min_26', 'price_min_30', 'price_min_200', 'price_min_1000', 'val_5', 'val_10', 'val_20', 'val_26', 'val_30', 'val_200', 'val_1000', 'val_max_5', 'val_max_10', 'val_max_20', 'val_max_26', 'val_max_30', 'val_max_200', 'val_max_1000', 'val_min_5', 'val_min_10', 'val_min_20', 'val_min_26', 'val_min_30', 'val_min_200', 'val_min_1000', 'vol_5', 'vol_10', 'vol_20', 'vol_26', 'vol_30', 'vol_200', 'vol_1000', 'vol_max_5', 'vol_max_10', 'vol_max_20', 'vol_max_26', 'vol_max_30', 'vol_max_200', 'vol_max_1000', 'vol_min_5', 'vol_min_10', 'vol_min_20', 'vol_min_26', 'vol_min_30', 'vol_min_200', 'vol_min_1000',]
        var showField = ['price_bb_lower', 'price_bb_middle', 'price_bb_pb', 'price_bb_upper', '(%)price_bb_lower', '(%)price_bb_middle', '(%)price_bb_pb', '(%)price_bb_upper', '(%)vol_30', '(%)val_30', '(%)val_10']
        var rowHead = $("#symbolHeadTable tr")
        var rowHeadTh = $("#symbolHeadTable tr th")
        rowHeadTh.each(function (index, element) {
            // Update the text by appending the index
            $(element).text($(element).text() + " (" + index + ")");
        });
        var numCol = rowHeadTh.length;
        console.log('Init numCol ', numCol, 'total ', numCol + indicatorField.length + pctField.length)
        var c = 0;

        basicField.forEach((f, i) => {
            mapFieldIndex[f] = i;
            if (defaultShowHide) mapFieldShowHide[f] = true;
        })
        indicatorField.forEach((f, i) => {
            rowHead.append(`<th>${f} (${numCol + i})</th>`)
            mapFieldIndex[f] = numCol + i;
            if (defaultShowHide) mapFieldShowHide[f] = false;
            c++;
        })
        pctField.forEach((f, i) => {
            rowHead.append(`<th>${'(%)' + f} (${numCol + c + i})</th>`)
            mapFieldIndex['(%)' + f] = numCol + c + i;
            if (defaultShowHide) mapFieldShowHide[f] = false;
        })
        showField.forEach((f) => {
            if (defaultShowHide) mapFieldShowHide[f] = true;
        })

        var indexShowField = defaultShowHide ? [...showField, ...basicField].map(e => { return mapFieldIndex[e] }) : Object.entries(mapFieldShowHide).filter(e => e[1]).map(e => mapFieldIndex[e[0]])
        var hideField = Array.from({ length: indicatorField.length + pctField.length + numCol }, (_, index) => index).filter(i => !indexShowField.includes(i))
        console.table(indexShowField)
        let ne = []
        indicatorField.forEach((f, i) => {
            ne[i] = 0
        })
        let pct = []
        pctField.forEach((f, i) => {
            pct[i] = 0
        })
        localStorage.setItem("mapFieldShowHide", JSON.stringify(mapFieldShowHide));
        $('#symbolTable').DataTable(
            {

                ajax: {
                    url: '/api/getsymbolsdata2', // Replace with your API endpoint
                    // dataSrc: 'data' // If your data is an array at the root level of the JSON response
                    dataSrc: function (res) {
                        console.log(res)
                        let data = res.data.map(e => {
                            let t = e[10] + e[12] + e[14]
                            let tv = e[11] + e[13] + e[15]
                            return [...e.slice(0, e.length - 2), t, tv, e.at(-2), e.at(-1), ...ne, ...pct]
                        })
                        // console.log(data)
                        return data;
                    }
                },
                fixedHeader: {
                    // header: true,
                    // footer: true
                },
                fixedColumns: {
                    left: 1,
                    left: 6,
                    right: 1
                },

                columnDefs: [
                    {
                        targets: Array.from({ length: indicatorField.length + pctField.length + numCol }, (_, index) => index),
                        className: 'dt-center'
                    },
                    { visible: false, targets: hideField, },
                    {
                        targets: 0,
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = '<a href="timeline?symbols=' + encodeURIComponent(data) + '"  target="_blank">' + data + '</a>';
                            }
                            return data;
                        }
                    }, {
                        targets: 2,
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = moment(data, 'X').format("MM/DD")
                            }
                            return data;
                        }
                    }],

                "rowCallback": function (row, data, index) {
                    if ((data[5] < 0)) {
                        // $(row).css('background-color', 'red');                
                        $('td:eq(5)', row).css('background-color', 'red');
                    }
                    else if ((data[5] > 0)) {
                        // $(row).css('background-color', 'green');
                        $('td:eq(5)', row).css('background-color', 'limegreen');
                    } else {
                        // $(row).css('background-color', 'yellow');
                        $('td:eq(5)', row).css('background-color', 'yellow');
                    }
                },
                processing: true,
                ordering: true,
                scroller: true,
                // scrollY: 200,
                searching: true,
                // serverSide: true,
                lengthMenu: [10, 20, 50, 100, 200, 500, 2000],
                dom: 'lBfrtip',
                buttons: [
                    'copy',
                    // 'csv', 
                    'excel', 'pdf',
                    // 'print', 
                    'colvis'
                ]
                // buttons: [
                //     {
                //         extend: 'copyHtml5',
                //         exportOptions: {
                //             columns: [0, ':visible']
                //         }
                //     },
                //     {
                //         extend: 'excelHtml5',
                //         exportOptions: {
                //             columns: ':visible'
                //         }
                //     },
                //     {
                //         extend: 'pdfHtml5',
                //         exportOptions: {
                //             columns: [0, 1, 2, 5]
                //         }
                //     },
                //     'colvis'
                // ]
            }
        );


        function initSymbolChangeTable(data) {
            $('#symbolChangeTable').DataTable(
                {
                    data: data,
                    fixedHeader: {
                        // header: true,
                        // footer: true
                    },
                    fixedColumns: {
                        left: 1,
                        right: 1
                    },
                    columnDefs: [
                        {
                            targets: 0,
                            render: function (data, type, row, meta) {
                                if (type === 'display') {
                                    data = '<a href="timeline?symbols=' + encodeURIComponent(data) + '"  target="_blank">' + data + '</a>';
                                }
                                return data;
                            }
                        },{
                        targets: 2,
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = moment(data, 'X').format("MM/DD")
                            }
                            return data;
                        }
                    }],
                    processing: true,
                    ordering: true,
                    scroller: true,
                    // scrollY: 200,
                    searching: true,
                    // serverSide: true,
                    lengthMenu: [10, 20, 50, 100, 200, 500, 2000],
                    dom: 'lBfrtip',
                    buttons: [
                        'copy',
                        // 'csv', 
                        'excel', 'pdf',
                        // 'print', 
                        'colvis'
                    ]
                    // buttons: [
                    //     {
                    //         extend: 'copyHtml5',
                    //         exportOptions: {
                    //             columns: [0, ':visible']
                    //         }
                    //     },
                    //     {
                    //         extend: 'excelHtml5',
                    //         exportOptions: {
                    //             columns: ':visible'
                    //         }
                    //     },
                    //     {
                    //         extend: 'pdfHtml5',
                    //         exportOptions: {
                    //             columns: [0, 1, 2, 5]
                    //         }
                    //     },
                    //     'colvis'
                    // ]
                }
            );
        }

        let lastSymbolChangeTable = null;
        let lastChange = 0;
        let lastChangeMap = {}
        let keepArray = []
        let timeout = 0;
        let lastMd5 = ''
        let lastAJAX = 0
        let data;
        let mapIndicator;
        $(document).ready(function () {
            $.ajax({
                url: '/api/indicator',
                method: 'GET',
                success: function (response) {
                    mapIndicator = response;
                },
                error: function (error) {
                    console.error('Error fetching updated data:', error);
                }
            });




            function updateDataTable() {
                if (Date.now() - lastAJAX <= timeout) {
                    return;
                }

                $.ajax({
                    url: querydate ? '/api/getsymbolsdata2?querydate=' + querydate : '/api/getsymbolsdata2', // Endpoint to get updated data
                    method: 'GET',
                    success: function (response) {
                        var table = $('#symbolTable').DataTable();
                        table.clear();
                        data = response.data.map(e => {
                            let t = e[10] + e[12] + e[14]
                            let tv = e[11] + e[13] + e[15]
                            return [...e.slice(0, e.length - 2), t, tv, e.at(-2), e.at(-1)]
                        })

                        var price;
                        var vol;
                        var val;
                        data.forEach(e => {
                            price = e[3] / 1000
                            vol = e[16]
                            val = e[17]
                            // console.table([e[0], price, vol, val])

                            let l = e.length;
                            // console.log(mapIndicator[e[0]],e)
                            if (mapIndicator && mapIndicator[e[0]]) {
                                indicatorField.forEach((f, i) => {
                                    var n = mapIndicator[e[0]][f];
                                    if (!Number.isInteger(n)) {
                                        n = Math.round(n * 100) / 100
                                    }
                                    e[l + i] = n
                                })
                                l = e.length;
                                pctField.forEach((f, i) => {
                                    if (f.includes('price')) {
                                        if (f.includes('max')) {
                                            e[l + i] = Math.floor((price - mapIndicator[e[0]][f]) / mapIndicator[e[0]][f] * 10000) / 100;
                                        } else if (f.includes('min')) {
                                            e[l + i] = Math.floor((price) / mapIndicator[e[0]][f] * 10000) / 100;
                                        } else {
                                            e[l + i] = Math.floor((price - mapIndicator[e[0]][f]) / price * 10000) / 100;
                                        }

                                    }
                                    if (f.includes('vol')) {
                                        e[l + i] = Math.floor((vol) / mapIndicator[e[0]][f] * 10000) / 100;
                                    }
                                    if (f.includes('val')) {
                                        e[l + i] = Math.floor((val) / mapIndicator[e[0]][f] * 10000) / 100;
                                    }
                                })
                            }

                        })
                        if (filterScript && filterScript.length > 0) {
                            data = filter(data, filterScript)
                        }
                        data.forEach(e => {
                            e.forEach((v, i) => {
                                if (i >= 6 && i < numCol && v)
                                    e[i] = numeral(v).format('0,0');
                            })

                        })

                        table.rows.add(data).draw()
                        let key = Math.floor(Date.now() / 1000 / interval);
                        if (!lastChangeMap[key]) {
                            lastChangeMap[key] = response.data;
                            keepArray.push({ 'key': key, 'data': response.data })
                            while (keepArray.length > 2) {
                                let out = keepArray.shift();
                                delete lastChangeMap[out.key]
                            }
                        }

                        if (!lastSymbolChangeTable) {
                            lastSymbolChangeTable = data;
                            lastChange = Date.now()
                            initSymbolChangeTable(data)
                        } else {
                            let lastSymbolChangeTable = keepArray[0].data

                            var table = $('#symbolChangeTable').DataTable();
                            table.clear();
                            let c1 = {}
                            lastSymbolChangeTable.forEach(e => {
                                c1[e[0]] = e
                            })
                            let c2 = {}
                            response.data.forEach(e => {
                                let a = []
                                e1 = c1[e[0]]
                                if (e1) { //Neu co thi tinh sai biet
                                    e.forEach((v, i) => {
                                        if (i <= 5) a[i] = v
                                        else {
                                            // a[i] = numeral(v - e1[i]).format('0,0')
                                            a[i] = v - e1[i]
                                        }
                                    });
                                } else { //Neu khong co thi tinh theo moi nhat
                                    a = e;
                                }

                                let t = a[10] + a[12] + a[14]
                                let tv = a[11] + a[13] + a[15]
                                a = [...a.slice(0, a.length - 2), t, tv, a.at(-2), a.at(-1)]
                                a.forEach((v, i) => {
                                    if (i >= 6) a[i] = numeral(v).format('0,0')
                                })
                                c2[e[0]] = a

                                // if (e[0] == 'DXG') console.table({ 'a': a, 'e1': e1, 'e': e })
                            })
                            table.rows.add(Object.values(c2)).draw()
                        }

                        lastAJAX = Date.now()
                        if (lastMd5 == response.md5) {
                            timeout += 1000
                            if (timeout >= 10000) {
                                timeout = 10000;
                                console.log('Timeout ', timeout, 'md5', response.md5)
                            }
                        } else {
                            timeout = 0;
                        }
                        // console.table(response)
                        lastMd5 = response.md5

                    },
                    error: function (error) {
                        console.error('Error fetching updated data:', error);
                    }
                });
            }

            // Update DataTable every 5 seconds (adjust as needed)
            setInterval(updateDataTable, 1000);
        });


        $(document).ready(function () {
            // Initialize DataTable
            var dataTable = $('#symbolTable').DataTable();

            // Add custom button to show settings modal
            $('#symbolTable_wrapper .dt-buttons').append('<button id="settingsButton" class="dt-button buttons-copy buttons-html5">Settings</button>');
            $('#symbolTable_wrapper .dt-buttons').append('<button id="settingsClear" class="dt-button buttons-copy buttons-html5">Clear</button>');
            $('#settingsClear').on('click', function () {
                localStorage.clear();
                location.reload();
            })

            $('#settingsModal').on('show.bs.modal', function (e) {
                // Vô hiệu hóa chức năng đóng modal khi nhấn vào phần bên ngoài
                $(this).data('bs.modal')._config.backdrop = 'static';
            });

            // Lắng nghe sự kiện hide modal
            $('#settingsModal').on('hide.bs.modal', function (e) {
                // Bật lại chức năng đóng modal khi nhấn vào phần bên ngoài khi modal đã ẩn đi
                $(this).data('bs.modal')._config.backdrop = true;
            });
            var col = 6;
            $('#settingsButton').on('click', function () {
                $('#macd').empty();
                $('#bb').empty();
                $('#price').empty();
                $('#vol').empty();
                $('#val').empty();
                $('#other').empty();
                $('#basic').empty();
                // Dynamically generate checkboxes for each indicator
                var count = {
                    // macd: 0, 
                    price: 0, vol: 0, val: 0,
                    // other: 0,
                    bb: 0
                }
                var field = [...pctField.map(e => '(%)' + e)]
                indicatorField.forEach(function (indicator) {
                    var checkbox = $('<div class="form-check flex-fill " style="width:  calc(100% / ' + col + '); height: 25px;">' +
                        '<input class="form-check-input" type="checkbox" value="' + indicator + '" id="' + indicator + 'Checkbox" ' + (mapFieldShowHide[indicator] ? 'checked' : '') + '>' +
                        '<label class="form-check-label" for="' + indicator + 'Checkbox">' + indicator + '</label>' +
                        '</div>');
                    checkbox.change(() => {
                        var colIndex = mapFieldIndex[indicator];
                        var dataTable = $('#symbolTable').DataTable();
                        if ($('#' + indicator + 'Checkbox').is(":checked")) {
                            // dataTable.column(colIndex).visible(true);
                            mapFieldShowHide[indicator] = true
                        } else {
                            // dataTable.column(colIndex).visible(false);
                            mapFieldShowHide[indicator] = false;
                        }
                        var column = dataTable.column(colIndex);
                        column.visible(!column.visible());
                        localStorage.setItem("mapFieldShowHide", JSON.stringify(mapFieldShowHide));
                    })
                    checkbox.children().on('mouseover', function () {
                        var randomColor = getRandomColor();
                        $(checkbox).css('background-color', randomColor);
                    });

                    checkbox.children().on('mouseout', function () {
                        $(checkbox).css('background-color', '');
                    });
                    if (indicator.includes('macd')) {
                        $('#macd').append(checkbox);
                        // count["macd"] += 1;
                    }
                    else if (indicator.includes('price') && !indicator.includes('_bb_')) {
                        $('#price').append(checkbox);
                        count["price"] += 1;
                    }
                    else if (indicator.includes('vol')) {
                        $('#vol').append(checkbox);
                        count["vol"] += 1;
                    }
                    else if (indicator.includes('val')) {
                        $('#val').append(checkbox);
                        count["val"] += 1;
                    }
                    else if (indicator.includes('_bb_')) {
                        $('#bb').append(checkbox);
                        count["bb"] += 1;
                    }
                    else {
                        $('#other').append(checkbox);
                        // count["other"] += 1;
                    }
                });

                for (let k in count) {
                    while (count[k] % col != 0) {
                        var checkbox = $('<div class="form-check flex-fill " style="width:  calc(100% / ' + col + ');"></div>');
                        $('#' + k).append(checkbox);
                        count[k] += 1;
                    }
                    var seperatorDiv = $('<div class="seperator">(%)</div>');
                    $('#' + k).append(seperatorDiv);
                }

                field.forEach(function (indicator) {
                    var checkbox = $('<div class="form-check flex-fill " style="width:  calc(100% / ' + col + '); height: 25px;">' +
                        '<input class="form-check-input" type="checkbox" value="' + indicator + '" id="' + indicator.replace('(%)', 'pct_') + 'Checkbox" ' + (mapFieldShowHide[indicator] ? 'checked' : '') + '>' +
                        '<label class="form-check-label" for="' + indicator.replace('(%)', 'pct_') + 'Checkbox">' + indicator + '</label>' +
                        '</div>');
                    checkbox.change(() => {
                        var colIndex = mapFieldIndex[indicator];
                        var dataTable = $('#symbolTable').DataTable();
                        if ($('#' + indicator.replace('(%)', 'pct_') + 'Checkbox').is(":checked")) {
                            // dataTable.column(colIndex).visible(true);
                            mapFieldShowHide[indicator] = true
                        } else {
                            // dataTable.column(colIndex).visible(false);
                            mapFieldShowHide[indicator] = false;
                        }
                        var column = dataTable.column(colIndex);
                        column.visible(!column.visible());
                        localStorage.setItem("mapFieldShowHide", JSON.stringify(mapFieldShowHide));
                    })
                    checkbox.children().on('mouseover', function () {
                        var randomColor = getRandomColor();
                        $(checkbox).css('background-color', randomColor);
                    });

                    checkbox.children().on('mouseout', function () {
                        $(checkbox).css('background-color', '');
                    });
                    if (indicator.includes('macd')) {
                        $('#macd').append(checkbox);
                        // count["macd"] += 1;
                    }
                    else if (indicator.includes('price') && !indicator.includes('_bb_')) {
                        $('#price').append(checkbox);
                        count["price"] += 1;
                    }
                    else if (indicator.includes('vol')) {
                        $('#vol').append(checkbox);
                        count["vol"] += 1;
                    }
                    else if (indicator.includes('val')) {
                        $('#val').append(checkbox);
                        count["val"] += 1;
                    }
                    else if (indicator.includes('_bb_')) {
                        $('#bb').append(checkbox);
                        count["bb"] += 1;
                    }
                    else {
                        $('#other').append(checkbox);
                        // count["other"] += 1;
                    }
                });

                for (let k in count) {
                    while (count[k] % col != 0) {
                        var checkbox = $('<div class="form-check flex-fill " style="width:  calc(100% / ' + col + ');"></div>');
                        $('#' + k).append(checkbox);
                        count[k] += 1;
                    }
                }
                count = { basic: 0 }
                basicField.forEach(function (indicator) {
                    var checkbox = $('<div class="form-check flex-fill " style="width:  calc(100% / ' + col + '); height: 25px;">' +
                        '<input class="form-check-input" type="checkbox" value="' + indicator + '" id="' + indicator.replace('%', 'pct_') + 'Checkbox" ' + (mapFieldShowHide[indicator] ? 'checked' : '') + '>' +
                        '<label class="form-check-label" for="' + indicator.replace('%', 'pct_') + 'Checkbox">' + indicator + '</label>' +
                        '</div>');

                    checkbox.change(() => {
                        var colIndex = mapFieldIndex[indicator];
                        var dataTable = $('#symbolTable').DataTable();
                        if ($('#' + indicator.replace('%', 'pct_') + 'Checkbox').is(":checked")) {
                            // dataTable.column(colIndex).visible(true);
                            mapFieldShowHide[indicator] = true
                        } else {
                            // dataTable.column(colIndex).visible(false);
                            mapFieldShowHide[indicator] = false;
                        }
                        var column = dataTable.column(colIndex);
                        column.visible(!column.visible());
                        localStorage.setItem("mapFieldShowHide", JSON.stringify(mapFieldShowHide));
                    })
                    //   perspective: 1000px;
                    //   transform-style: preserve-3d;
                    //   transition: transform 0.5s ease-in-out;
                    checkbox.children().on('mouseover', function () {
                        var randomColor = getRandomColor();
                        $(checkbox).css({
                            'background-color': randomColor,
                            'perspective': '1000px',
                            'transform-style': 'preserve-3d',
                            'transition': 'transform 0.5s ease-in-out',
                        });
                    });

                    checkbox.children().on('mouseout', function () {
                        $(checkbox).css('background-color', '');
                    });

                    $('#basic').append(checkbox);
                    count["basic"] += 1;
                });

                for (let k in count) {
                    while (count[k] % col != 0) {
                        var checkbox = $('<div class="form-check flex-fill " style="width:  calc(100% / ' + col + ');"></div>');
                        $('#' + k).append(checkbox);
                        count[k] += 1;
                    }
                }
                // Show Bootstrap modal
                $('#settingsModal').modal('show');
            });
        });
    </script>
</body>

</html>