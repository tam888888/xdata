<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://echarts.apache.org/en/js/vendors/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <title>Timelines 1000 Symbols</title>
    <style>
        /* Thêm CSS để tạo biểu đồ rộng toàn màn hình */
        #timelineChart {
            width: calc(80% - 40px);
            /* Trừ đi 40px từ padding */
            height: 1200px;
            padding-left: 20px;
            padding-right: 20px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <button id="toggleLabel">Bật/Tắt Label</button>
    <button id="toggleLabelDiametter">Bật/Tắt Label KC</button>
    <div id="timelineChart"></div>

    <script>
        function getNowDate() {
            let fd = new Date();
            return fd.getFullYear()
                + "" + (fd.getMonth() + 1 < 10 ? "0" + (fd.getMonth() + 1) : fd.getMonth() + 1)
                + "" + (fd.getDate() < 10 ? "0" + fd.getDate() : fd.getDate());
        }

        const url = new URL(window.location.href);
        const queryParams = url.searchParams;
        var interval = queryParams.get('interval');
        if (!interval) interval = 10000
        else interval = +interval
        var querydate = queryParams.get('querydate');
        // if (!querydate) querydate = getNowDate()

        var dom = document.getElementById('timelineChart');
        var myChart = echarts.init(dom, null, {
            renderer: 'webgl',
            // useDirtyRect: false
        });
        var D = 2; // Ngưỡng khoảng cách tối thiểu

        function computeLabels(data, D) {
            let lastIndex = 0; // Lưu vị trí điểm gần nhất có label
            return data.map((point, i) => {
                if (i === 0 || Math.abs(point.value[0] - data[lastIndex].value[0]) >= D) {
                    lastIndex = i; // Cập nhật điểm gần nhất có label
                    return { value: point.value, label: { show: true } };
                }
                return { value: point.value, label: { show: false } };
            });
        }

        document.getElementById('toggleLabelDiametter').addEventListener('click', function () {
            var processedData = computeLabels(data, D);
            myChart.setOption({
                series: [{
                    type: 'scatter',
                    data: processedData
                }]
            });
        });

        var labelsEnabled = false; // Trạng thái mặc định: tắt nhãn

        document.getElementById('toggleLabel').addEventListener('click', function () {
            labelsEnabled = !labelsEnabled; // Đảo trạng thái bật/tắt

            myChart.setOption({
                series: [{
                    label: {
                        show: labelsEnabled // Bật/tắt label dựa trên trạng thái
                    }
                }, {
                    label: {
                        show: labelsEnabled // Bật/tắt label dựa trên trạng thái
                    }
                }, {
                    label: {
                        show: labelsEnabled // Bật/tắt label dựa trên trạng thái
                    }
                }, {
                    label: {
                        show: labelsEnabled // Bật/tắt label dựa trên trạng thái
                    }
                }]
            });
        });

        var URL = querydate ? '/api/getsymboldataseries2?querydate=' + querydate : '/api/getsymboldataseries'
        var URL2 = querydate ? 'https://3001-tam888888-abc-j2wdppywozw.ws-us118.gitpod.io/proxy/api/getsymboldataseries2?querydate=' + querydate : 'https://3001-tam888888-abc-j2wdppywozw.ws-us118.gitpod.io/proxy/api/getsymboldataseries'

        // var ROOT_PATH = 'https://3001-tam888888-abc-j2wdppywozw.ws-us118.gitpod.io/proxy/api/getsymboldataseries'
        var ROOT_PATH = URL;
        var option;

        var adata = [];

        var val = (e) => {
            return !e ? 0 : e
        }

        // setInterval(() => {
        $.get(ROOT_PATH, function (data) {
            console.log("Load data")
            myChart.hideLoading();
            Object.values(data).forEach(e => { adata.push(...Object.entries(e).filter(e => e[0] != 'dataacum').map(e => e[1]).map(e => { e['time_symbol'] = e['time'] + "_" + e['symbol']; return e })) })

            adata = adata.map(e => {
                return {
                    ...e,
                    total_val: (val(e['bu_val']) + val(e['sd_val']) + val(e['unknown_val']))
                    , busd: (val(e['bu_val']) - val(e['sd_val']))
                }
            })
            adata.sort((a, b) => {
                if (a['T'] !== b['T']) {
                    return a['T'] - b['T']; // Sắp xếp theo T trước
                }
                return a['symbol'].localeCompare(b['symbol']); // Nếu T giống nhau, sắp xếp theo symbol
            });
            myChart.setOption(
                (option = {
                    tooltip: {
                        trigger: 'item',
                        triggerOn: 'mousemove',
                        formatter: function (data) {
                            // Truy cập vào dữ liệu cần hiển thị trong tooltip
                            var price = data.data['price'];
                            var priceref = data.data['priceref'];
                            var ceiling = data.data['ceiling'];
                            var floor = data.data['floor'];
                            var change = data.data['change'];
                            var pct = data.data['pct'];
                            var x = data.data;
                            var total_val = val(x['bu_val']) + val(x['sd_val']) + val(x['unknown_val'])
                            var total = val(x['bu_vol']) + val(x['sd_vol']) + val(x['unknown_vol'])
                            total_val = numeral(total_val).format('0,0')
                            total = numeral(total).format('0,0')
                            // Tạo chuỗi tooltip theo định dạng yêu cầu
                            return `
                                    <div><strong>Symbol:</strong> ${data.data['symbol']}</div>
                                    <div><strong>Val:</strong> ${total_val}</div>
                                    <div><strong>Vol:</strong> ${total}</div>
                                    <div><strong>Price:</strong> ${price}</div>
                                    <div><strong>Price Reference:</strong> ${priceref}</div>
                                    <div><strong>Change:</strong> ${change}</div>
                                    <div><strong>Percentage:</strong> ${pct}%</div>
                                    <div><strong>Ceiling:</strong> ${ceiling}</div>
                                    <div><strong>Floor:</strong> ${floor}</div>
                                `;
                        }
                    },
                    legend: { data: ['pct', 'busd', 'bu_val', 'total_val', 'sd_val'] },
                    dataset: {
                        dimensions: ['time_symbol', 'pct', 'busd', 'total_val', 'bu_val', 'sd_val'],

                        source: adata,
                    },
                    xAxis: { type: 'category', top: '80%' },
                    yAxis: {},
                    dataZoom: [
                        {
                            type: 'inside',
                            start: 90,
                            end: 100
                        },
                        {
                            show: true,
                            type: 'slider',
                            top: '95%',
                            start: 90,
                            end: 100
                        }
                    ],

                    // dataZoom: [
                    //     {
                    //         type: 'inside',
                    //         xAxisIndex: 0,  // Zoom theo trục X
                    //         yAxisIndex: 0,  // Zoom theo trục Y
                    //         start: 50,
                    //         end: 100
                    //     },
                    //     {
                    //         show: true,
                    //         type: 'slider',
                    //         xAxisIndex: 0,  // Thanh zoom ngang
                    //         top: '90%',
                    //         start: 50,
                    //         end: 100
                    //     },
                    //     {
                    //         show: true,
                    //         type: 'slider',
                    //         yAxisIndex: 0,  // Thanh zoom dọc
                    //         right: '5%',  // Đặt vị trí bên phải
                    //         start: 50,
                    //         end: 100
                    //     }
                    // ],
                    series: [
                        {
                            type: 'scatter',
                            symbolSize: function (data) {
                                // console.log(data)
                                var size = Math.sqrt((val(data['bu_val']) + val(data['sd_val']) + val(data['unknown_val'])) / 1e8);
                                if (size <= 2) size = 2
                                return size;  // Điều chỉnh kích thước điểm
                            },
                            large: true, // Enable large-scale optimization
                            largeThreshold: 70000,
                            // progressive: 5000, // Progressive rendering (vẽ từng phần)
                            itemStyle: {
                                color: function (data) {
                                    var price = data.data['price'];
                                    var priceref = data.data['priceref'];
                                    var ceiling = data.data['ceiling'];
                                    var floor = data.data['floor'];

                                    // Nếu price bằng ceiling thì chọn màu tím
                                    if (price == ceiling) {
                                        return 'purple'; // Màu tím nếu giá bằng với ceiling
                                    }
                                    // Nếu price bằng floor thì chọn màu xanh lơ
                                    else if (price == floor) {
                                        return 'lightblue'; // Màu xanh lơ nếu giá bằng với floor
                                    }
                                    // Nếu không thì chọn màu xanh nếu price >= priceref, ngược lại đỏ
                                    else {
                                        return price >= priceref ? 'rgb(0, 255, 0)' : 'rgb(255, 0, 0)';
                                    }
                                }
                            },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function (data) {
                                    // console.log(data)
                                    // Kiểm tra pct để chỉ hiển thị nhãn nếu pct > 3 hoặc pct < -3
                                    var x = data.data;
                                    var total = val(x['bu_val']) + val(x['sd_val']) + val(x['unknown_val'])
                                    if (
                                        (total >= 1e8 && (x['pct'] > 2 || x['pct'] < -3))
                                        || (total >= 1e9 && (x['pct'] > 0.7 || x['pct'] < -3))
                                        // || (x['pct'] > 6 || x['pct'] < -6)
                                    ) {
                                        return `${x['symbol']}`; // Hiển thị pct của symbol
                                    }
                                    return ''; // Không hiển thị gì nếu pct không thoả mãn điều kiện
                                },
                                fontSize: 12,  // Điều chỉnh font size ở đây
                                // fontWeight: 'bold',
                                color: '#333'
                            },
                        }, {
                            type: 'scatter',
                            symbolSize: function (data) {
                                // console.log(data)
                                var size = Math.sqrt((val(data['bu_val']) + val(data['sd_val']) + val(data['unknown_val'])) / 1e8);
                                if (size <= 2) size = 2
                                return size;  // Điều chỉnh kích thước điểm
                            },
                            large: true, // Enable large-scale optimization
                            largeThreshold: 70000,
                            // progressive: 5000, // Progressive rendering (vẽ từng phần)
                            itemStyle: {
                                color: function (data) {
                                    var price = data.data['price'];
                                    var priceref = data.data['priceref'];
                                    var ceiling = data.data['ceiling'];
                                    var floor = data.data['floor'];

                                    // Nếu price bằng ceiling thì chọn màu tím
                                    if (price == ceiling) {
                                        return 'purple'; // Màu tím nếu giá bằng với ceiling
                                    }
                                    // Nếu price bằng floor thì chọn màu xanh lơ
                                    else if (price == floor) {
                                        return 'lightblue'; // Màu xanh lơ nếu giá bằng với floor
                                    }
                                    // Nếu không thì chọn màu xanh nếu price >= priceref, ngược lại đỏ
                                    else {
                                        return price >= priceref ? 'rgb(0, 255, 0)' : 'rgb(255, 0, 0)';
                                    }
                                }
                            },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function (data) {
                                    // console.log(data)
                                    // Kiểm tra pct để chỉ hiển thị nhãn nếu pct > 3 hoặc pct < -3
                                    var x = data.data;
                                    var total = val(x['bu_val']) + val(x['sd_val']) + val(x['unknown_val'])
                                    if (
                                        (total >= 1e8 && (x['pct'] > 2 || x['pct'] < -3))
                                        || (total >= 1e9 && (x['pct'] > 0.7 || x['pct'] < -3))
                                        // || (x['pct'] > 6 || x['pct'] < -6)
                                    ) {
                                        return `${x['symbol']}`; // Hiển thị pct của symbol
                                    }
                                    return ''; // Không hiển thị gì nếu pct không thoả mãn điều kiện
                                },
                                fontSize: 12,  // Điều chỉnh font size ở đây
                                // fontWeight: 'bold',
                                color: '#333'
                            },
                        },
                        {
                            type: 'scatter',
                            symbolSize: function (data) {
                                // console.log(data)
                                var size = Math.sqrt((val(data['bu_val']) + val(data['sd_val']) + val(data['unknown_val'])) / 1e8);
                                if (size <= 2) size = 2
                                return size;  // Điều chỉnh kích thước điểm
                            },
                            large: true, // Enable large-scale optimization
                            largeThreshold: 70000,
                            // progressive: 5000, // Progressive rendering (vẽ từng phần)
                            itemStyle: {
                                color: function (data) {
                                    var price = data.data['price'];
                                    var priceref = data.data['priceref'];
                                    var ceiling = data.data['ceiling'];
                                    var floor = data.data['floor'];

                                    // Nếu price bằng ceiling thì chọn màu tím
                                    if (price == ceiling) {
                                        return 'purple'; // Màu tím nếu giá bằng với ceiling
                                    }
                                    // Nếu price bằng floor thì chọn màu xanh lơ
                                    else if (price == floor) {
                                        return 'lightblue'; // Màu xanh lơ nếu giá bằng với floor
                                    }
                                    // Nếu không thì chọn màu xanh nếu price >= priceref, ngược lại đỏ
                                    else {
                                        return price >= priceref ? 'rgb(0, 255, 0)' : 'rgb(255, 0, 0)';
                                    }
                                }
                            },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function (data) {
                                    // console.log(data)
                                    // Kiểm tra pct để chỉ hiển thị nhãn nếu pct > 3 hoặc pct < -3
                                    var x = data.data;
                                    var total = val(x['bu_val']) + val(x['sd_val']) + val(x['unknown_val'])
                                    if (
                                        (total >= 1e8 && (x['pct'] > 2 || x['pct'] < -3))
                                        || (total >= 1e9 && (x['pct'] > 0.7 || x['pct'] < -3))
                                        // || (x['pct'] > 6 || x['pct'] < -6)
                                    ) {
                                        return `${x['symbol']}`; // Hiển thị pct của symbol
                                    }
                                    return ''; // Không hiển thị gì nếu pct không thoả mãn điều kiện
                                },
                                fontSize: 12,  // Điều chỉnh font size ở đây
                                // fontWeight: 'bold',
                                color: '#333'
                            },
                        },
                        {
                            type: 'scatter',
                            symbolSize: function (data) {
                                // console.log(data)
                                var size = Math.sqrt((val(data['bu_val']) + val(data['sd_val']) + val(data['unknown_val'])) / 1e8);
                                if (size <= 2) size = 2
                                return size;  // Điều chỉnh kích thước điểm
                            },
                            large: true, // Enable large-scale optimization
                            largeThreshold: 70000,
                            // progressive: 5000, // Progressive rendering (vẽ từng phần)
                            itemStyle: {
                                color: function (data) {
                                    var price = data.data['price'];
                                    var priceref = data.data['priceref'];
                                    var ceiling = data.data['ceiling'];
                                    var floor = data.data['floor'];

                                    // Nếu price bằng ceiling thì chọn màu tím
                                    if (price == ceiling) {
                                        return 'purple'; // Màu tím nếu giá bằng với ceiling
                                    }
                                    // Nếu price bằng floor thì chọn màu xanh lơ
                                    else if (price == floor) {
                                        return 'lightblue'; // Màu xanh lơ nếu giá bằng với floor
                                    }
                                    // Nếu không thì chọn màu xanh nếu price >= priceref, ngược lại đỏ
                                    else {
                                        return price >= priceref ? 'rgb(0, 255, 0)' : 'rgb(255, 0, 0)';
                                    }
                                }
                            },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function (data) {
                                    // console.log(data)
                                    // Kiểm tra pct để chỉ hiển thị nhãn nếu pct > 3 hoặc pct < -3
                                    var x = data.data;
                                    var total = val(x['bu_val']) + val(x['sd_val']) + val(x['unknown_val'])
                                    if (
                                        (total >= 1e8 && (x['pct'] > 2 || x['pct'] < -3))
                                        || (total >= 1e9 && (x['pct'] > 0.7 || x['pct'] < -3))
                                        // || (x['pct'] > 6 || x['pct'] < -6)
                                    ) {
                                        return `${x['symbol']}`; // Hiển thị pct của symbol
                                    }
                                    return ''; // Không hiển thị gì nếu pct không thoả mãn điều kiện
                                },
                                fontSize: 12,  // Điều chỉnh font size ở đây
                                // fontWeight: 'bold',
                                color: '#333'
                            },
                        },

                    ]

                })
            );

        });
        // }, interval)


        myChart.on('dataZoom', function (params) {
            var start = params.batch ? params.batch[0].start : params.start;
            var end = params.batch ? params.batch[0].end : params.end;

            var zoomRange = end - start;
            var showLabel = zoomRange <= 10;  // Nếu zoom nhỏ hơn 10% thì hiển thị nhãn

            myChart.setOption({
                series: [{
                    label: {
                        show: showLabel
                    }
                }, {
                    label: {
                        show: showLabel
                    }
                }, {
                    label: {
                        show: showLabel
                    }
                }, {
                    label: {
                        show: showLabel
                    }
                }]
            });
        });

        // if (option && typeof option === 'object') {
        //     myChart.setOption(option);
        // }

        // window.addEventListener('resize', myChart.resize);


    </script>
</body>

</html>